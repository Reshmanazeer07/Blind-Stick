<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistive Stick Tracker â€” Leaflet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; }
        #map { height: 100%; width: 100%; border-radius: 0.5rem; }
        #loginScreen { position:fixed; inset:0; background:rgba(17,24,39,0.8); display:flex; align-items:center; justify-content:center; z-index:9999 }
        #loginCard { background:white; padding:24px; border-radius:8px; width:320px; }
        .small-muted { font-size:0.85rem; color:#6b7280 }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login overlay -->
    <div id="loginScreen" aria-hidden="false">
        <div id="loginCard" role="dialog" aria-label="Login">
            <h2 class="text-xl font-bold mb-2">Please sign in</h2>
            <p class="small-muted mb-4">Enter the app password to continue.</p>
            <input id="loginPassword" type="password" placeholder="Password" class="w-full px-3 py-2 border rounded mb-3" />
            <button id="loginBtn" class="w-full py-2 bg-indigo-600 text-white rounded">Sign in</button>
            <p class="mt-3 text-xs text-gray-500">Default password: <code>letmein</code></p>
            <p id="loginError" class="text-red-600 text-sm mt-2" style="display:none"></p>
        </div>
    </div>

    <!-- App content hidden until login -->
    <div id="appContent" style="display:none">
        <div class="flex flex-col md:flex-row h-screen p-4 space-y-4 md:space-y-0 md:space-x-4">

            <div class="bg-white p-6 shadow-xl rounded-xl w-full md:w-96 flex-shrink-0 flex flex-col space-y-4">
                <h1 class="text-2xl font-bold text-indigo-700">Assistive Stick Tracker</h1>
                <p class="text-sm text-gray-600">Live map with OpenStreetMap (Leaflet) and reverse geocoding.</p>

                <div class="border-t pt-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Device ID:</span>
                        <span class="text-sm font-mono text-gray-900">SIH-83055-001</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Status:</span>
                        <span id="statusText" class="px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">Online</span>
                    </div>
                </div>

                <div class="border-t pt-4 space-y-3">
                    <h2 class="text-lg font-semibold text-gray-700">Current Location:</h2>
                    <div class="bg-indigo-50 p-3 rounded-lg text-sm text-indigo-800 font-semibold shadow-inner">
                        <p id="currentPlaceName" class="italic">Fetching location name...</p>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg font-mono text-sm">
                        <p>Lat: <span id="currentLat">...</span></p>
                        <p>Lng: <span id="currentLng">...</span></p>
                    </div>

                    <!-- Stored address display -->
                    <div class="mt-2 bg-white p-3 rounded border text-sm">
                        <div class="flex justify-between items-center">
                            <strong>Stored Address</strong>
                            <button id="clearStored" class="text-xs text-red-600">Clear</button>
                        </div>
                        <p id="storedAddress" class="text-gray-700 italic mt-2">No stored address yet.</p>
                        <p id="storedAddressTs" class="text-xs text-gray-500 mt-1"></p>
                    </div>

                    <div class="mt-3 space-y-2">
                        <div class="mt-2">
                            <button onclick="useMyLocationNow()" class="w-full py-2 rounded bg-yellow-500 text-black text-sm">Use My Location Now</button>
                        </div>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t text-xs text-gray-500">
                    <p><strong>Centered Location:</strong> Karur, Tamil Nadu (fallback).</p>
                    <p><strong>Tech:</strong> Leaflet, OpenStreetMap, Nominatim reverse geocoding.</p>
                </div>
            </div>

            <div class="bg-white shadow-xl rounded-xl w-full h-full">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Simple client password (change as needed)
        const APP_PASSWORD = 'letmein';

        // Login logic
        const loginScreen = document.getElementById('loginScreen');
        const appContent = document.getElementById('appContent');
        document.getElementById('loginBtn').addEventListener('click', attemptLogin);
        document.getElementById('loginPassword').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') attemptLogin(); });

        function attemptLogin() {
            const val = document.getElementById('loginPassword').value || '';
            if (val === APP_PASSWORD) {
                sessionStorage.setItem('loggedIn','true');
                loginScreen.style.display = 'none';
                appContent.style.display = 'block';
                initApp();
            } else {
                const el = document.getElementById('loginError');
                el.style.display = 'block';
                el.textContent = 'Incorrect password.';
            }
        }

        if (sessionStorage.getItem('loggedIn') === 'true') {
            loginScreen.style.display = 'none';
            appContent.style.display = 'block';
            window.addEventListener('load', initApp);
        }

        // Map and location variables
        let leafletMap, leafletMarker;
        let simulationInterval;
        let currentLocation = { lat: 10.95, lng: 78.08 };

        function createMarkerIcon() {
            const size = 20;
            const color = '#4f46e5';
            const stroke = '#ffffff';
            const svg = `<?xml version="1.0" encoding="UTF-8"?><svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'><circle cx='${size/2}' cy='${size/2}' r='${size/2 - 1}' fill='${color}' stroke='${stroke}' stroke-width='2' /></svg>`;
            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
        }

        // Initialize app: map, geolocation, UI
        function initApp() {
            try {
                leafletMap = L.map('map').setView([currentLocation.lat, currentLocation.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(leafletMap);

                const icon = L.icon({ iconUrl: createMarkerIcon(), iconSize: [20,20], iconAnchor: [10,10] });
                leafletMarker = L.marker([currentLocation.lat, currentLocation.lng], { icon }).addTo(leafletMap);

                // (caretaker phone removed) no persisted phone loaded

                // Load stored address into UI
                loadStoredAddressToUI();

                // Try to get current position
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        currentLocation = { lat, lng };
                        updateLocationUI(lat, lng);
                        leafletMarker.setLatLng([lat, lng]);
                        leafletMap.setView([lat, lng], 15);
                        fetchAndStoreAddress(lat, lng);
                    }, err => {
                        console.warn('Geolocation error', err);
                        updateLocationUI(currentLocation.lat, currentLocation.lng);
                        fetchAndStoreAddress(currentLocation.lat, currentLocation.lng);
                    }, { enableHighAccuracy:true, timeout:8000 });
                } else {
                    updateLocationUI(currentLocation.lat, currentLocation.lng);
                    fetchAndStoreAddress(currentLocation.lat, currentLocation.lng);
                }

                startSimulation();

                document.getElementById('clearStored').addEventListener('click', () => {
                    localStorage.removeItem('lastAddress');
                    localStorage.removeItem('lastAddressTs');
                    loadStoredAddressToUI();
                });
            } catch (e) { console.error('initApp error', e); }
        }

        function updateLocationUI(lat, lng) {
            document.getElementById('currentLat').textContent = lat.toFixed(5);
            document.getElementById('currentLng').textContent = lng.toFixed(5);
        }

        // Reverse geocode using Nominatim and store result
        async function fetchAndStoreAddress(lat, lng) {
            const placeEl = document.getElementById('currentPlaceName');
            placeEl.textContent = 'Updating address...';
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error('Nominatim error ' + res.status);
                const data = await res.json();
                const display = data.display_name || 'Address not found.';
                placeEl.textContent = display;
                // store latest address
                try {
                    localStorage.setItem('lastAddress', display);
                    localStorage.setItem('lastAddressTs', new Date().toISOString());
                } catch (e) { console.warn('localStorage save failed', e); }
                loadStoredAddressToUI();
            } catch (e) {
                console.error('Reverse geocode failed', e);
                placeEl.textContent = 'Failed to fetch address.';
            }
        }

        function loadStoredAddressToUI() {
            const a = localStorage.getItem('lastAddress');
            const ts = localStorage.getItem('lastAddressTs');
            const el = document.getElementById('storedAddress');
            const elTs = document.getElementById('storedAddressTs');
            if (a) {
                el.textContent = a;
                elTs.textContent = ts ? `Saved: ${new Date(ts).toLocaleString()}` : '';
            } else {
                el.textContent = 'No stored address yet.';
                elTs.textContent = '';
            }
        }

        // Movement simulation (keeps marker moving slowly)
        function simulateMovement() {
            const latChange = (Math.random() - 0.5) * 0.0001;
            const lngChange = (Math.random() - 0.5) * 0.0001;
            const newLat = currentLocation.lat + latChange;
            const newLng = currentLocation.lng + lngChange;
            currentLocation = { lat: newLat, lng: newLng };
            if (leafletMarker) leafletMarker.setLatLng([newLat, newLng]);
            if (leafletMap) leafletMap.panTo([newLat, newLng]);
            updateLocationUI(newLat, newLng);
            fetchAndStoreAddress(newLat, newLng);
        }

        function startSimulation() { if (simulationInterval) clearInterval(simulationInterval); simulationInterval = setInterval(simulateMovement, 6000); }
        function stopSimulation() { clearInterval(simulationInterval); }

        // Re-request geolocation
        function useMyLocationNow() {
            if (!navigator.geolocation) { showToast('Geolocation not available.'); return; }
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                currentLocation = { lat, lng };
                if (leafletMarker) leafletMarker.setLatLng([lat, lng]);
                if (leafletMap) leafletMap.setView([lat, lng], 15);
                updateLocationUI(lat, lng);
                fetchAndStoreAddress(lat, lng);
                showToast('Location updated.');
            }, err => { showToast('Failed to get location: ' + (err.message||'error')); }, { enableHighAccuracy:true, timeout:8000 });
        }

        // Show toast notifications
        function showToast(msg, timeout=3000) {
            let t = document.getElementById('toast');
            if (!t) { t = document.createElement('div'); t.id='toast'; t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='rgba(17,24,39,0.95)'; t.style.color='white'; t.style.padding='10px 16px'; t.style.borderRadius='8px'; t.style.zIndex=99999; document.body.appendChild(t); }
            t.textContent = msg; t.style.display='block'; clearTimeout(t._hide); t._hide = setTimeout(()=>t.style.display='none', timeout);
        }

        // WhatsApp and voice features removed per request.

        // If app not logged in, initApp will be called after login. If already logged, initApp will run on load.
    </script>
</body>
</html>